# VSM Restaurant
Учебный проект для магистратуры IT-инженер ВСМ в РУТ, 2025.

Изначально здесь есть лишь заготовка проекта с демонстрацией того, как использовать fastapi, sqlmodel (sqlalchemy), alembic, postgresql, docker.

## Легенда
Напоминаю, что по легенде мы делаем сервис для питания пассажиров на борту поезда ВСМ. Ниже - краткий конспект того, что мы обсуждали на прошлом занятии.

### Основные предположения
- Заказ - через локальный сайт (aka Попутчик)
- В реальности еду скорее всего будут просто разносить готовую. Но для усложнения архитектуры считаем, что есть кухня и процесс готовки, а одни и те же ингридиенты могут использоваться в разных блюдах.
- Поддерживаем и предоплату (картой онлайн), и постоплату (терминал или наличные). 
- Понимаем, что в любой момент связь может отвалиться и онлайн-оплату завершить не удастся. Тогда даем пользователю вариант переключения на постоплату (терминал/наличные) или отказаться от заказа.

### Интерфейсы
* Для пользователей (пассажиров)
* Для поставщиков продуктов
* Для поваров
* Для проводников/официантов

### Модель данных
Примечание: Не стоит воспринимать написанное ниже как истину в последней инстанции. Это результат коллективного творчества, который не верифицировался на практике.

* Меню
    * ID
    * Название
    * Цена
    * Состав (JSONB Array)
        * ID ингридиента
        * Количество ингридиента
* Ингридиенты
    * ID
    * Название
    * Остаток
* Заказы
    * ID заказа
    * ID места
    * Время создания
    * ID транзакции
    * Форма оплаты
        * Оплата картой онлайн
        * Оплата картой терминал
        * Наличка
    * Статус
        * Ожидает оплаты
        * Оплачен
        * Готовится
        * Частично доставлен
        * Завершен
    * Стоимость
* Задачи на готовку
    * ID задачи
    * ID заказа
    * ID блюда (из меню)
    * Время создания
    * Статус
        * В очереди
        * Готовится
        * Готов
        * Доставляется
        * Доставлен

## Задачи

### 1. Запустить проект "как есть"
- Поднять постгрес в докере
- Запустить проект
- Убедиться, что все успешно стартануло и миграции накатились
- Подергать REST API, посмотреть что происходит в БД
- Разобраться, как все устроено

### 2. Реализовать MVP для Menu API
- Сделать набор служебных эндпойнтов для создания / редактирования / удаления пунктов меню
- Сделать публичный эндпойнт для отдачи меню (списка позиций, доступных для заказа)
- Защитить служебные эндпойнты требованием статического токена в Authorization header.

Доступность элементов в меню для заказа пока регулируем вручную через служебные эндпойнты (т.к. пока мы ничего не знаем про состав позиций меню и остатки продуктов).

### 3. Продукты
- Теперь каждая позиция меню должна содержать информацию о том, какие продукты (и в каком количестве) нужны для ее приготовления
- Появляется таблица с остатками продуктов и API для управления ей.
- Доступность позиций в меню определяется наличием необходимых продуктов
- Служебные API пополняются методами для поставщиков продуктов

### 4. Заказы
- Создаем API для оформления заказов
- Пока исходим из того, что поддерживается только "постоплата" (в момент доставки готового заказа проводником)
  - При этом при оформлении заказа все равно нужно выбирать, будет ли оплата наличными или картой (чтобы проводник знал, брать ли с собой терминал)
- Нужны API для кухни (поваров), проводников (выполняющих функцию официантов) и пользователей (просмотр статуса заказа)

### 5. Предоплата
- Добавляем возможность предоплаты картой
  - Такие заказы не уходят на кухню до тех пор, пока не будут оплачены
- Вместо API банка-эквайера пишем сбоку еще один микросервис, который будет выполнять его функции (генерировать ссылки на страницу оплаты, уведомлять нас вебхуком о завершении оплаты, делать возвраты)
- Учитываем, что в "полевых" условиях связь может отвалиться в любой момент, и это нужно предусмотреть
  - До момента получения вебхука о завершении оплаты позволяем пользователю отказаться от онлайн-оплаты и выбрать альтернативный вариант:
    - Постоплата
      - Оплата картой в POS-терминале (проводнику) после доставки заказа
      - Оплата наличными
    - Отмена заказа (заказ еще не начали готовить, так что норм)
  - Нужно корректно обрабатывать ситуацию, когда к нам внезапно прилетает вебхук о завершении оплаты в момент, когда пользователь переключился на постоплату или отменил заказ.
    - В таком случае нужно делать возврат денег через API банка-эквайера

## Cheatsheet
### Развертывание PostgreSQL
Все уже настроено в docker-compose.yml, достаточно запустить `docker-compose up -d`.

Для простоты пароль к учетке постгреса уже прописан в config.env и alembic.ini (но пожалуйста, не комитьте секреты в git в реальных проектах).

### Alembic
#### Генерация новых миграций
alembic revision --autogenerate -m "Add demo model"

Hint: Не забудьте добавить импорт новых моделей в `vsm_restaurant/db/__init__.py`

Пример запуска:
```
(.venv) ➜  vsm-restaurant git:(main) ✗ alembic revision --autogenerate -m "Add demo model"
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.autogenerate.compare] Detected added table 'demo'
INFO  [alembic.autogenerate.compare] Detected added index 'demo_timestamp_idx' on '('timestamp',)'
  Generating /Users/wutiarn/PycharmProjects/miit/vsm-restaurant/alembic/versions/61d371fd62af_add_demo_model.py ...  done
```
```
(.venv) ➜  vsm-restaurant git:(main) ✗ alembic revision --autogenerate -m "Add json data to demo"
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.ddl.postgresql] Detected sequence named 'demo_id_seq' as owned by integer column 'demo(id)', assuming SERIAL and omitting
INFO  [alembic.autogenerate.compare] Detected added column 'demo.json_data'
  Generating /Users/wutiarn/PycharmProjects/miit/vsm-restaurant/alembic/versions/5ad79c711b2f_add_json_data_to_demo.py ...  done
  ```
